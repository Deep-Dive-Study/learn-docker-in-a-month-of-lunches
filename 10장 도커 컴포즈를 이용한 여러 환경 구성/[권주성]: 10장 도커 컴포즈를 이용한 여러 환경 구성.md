# 10장 도커 컴포즈를 이용한 여러 환경 구성
- 도커 컴포즈는 환경에 따라 어플리케이션을 여러개의 다른 설정으로 배포가 가능함
- 이는, 도커 컴포즈의 큰 장점이자 사용 목적임
  - 도커 컴포즈는 운영 환경이 아닌 테스트 환경에서 여러 컴포넌트 간의 통신을 테스트하기 용이함
  - 문서화의 역할도 할 수 있음

## 10.1 도커 컴포즈로 여러 개의 애플리케이션 배포하기
- 회사에서는 같은 어플리케이션을 설정만 달리해서 서로 다른 환경에서 실행해야하는 경우가 있음
- 특히, 스케일링이 필요하지 않고, 성능적으로도 요구가 되지 않은 비운영 환경을 구성하는데 매우 용이함
- 도커 리소스가 어떤 어플리케이션의 일부인지 아닌지를 판정하기 위해 프로젝트라는 개념을 사용함
  - 프로젝트 이름을 리소스의 이름에 접두사로 붙이고 컨테이너 이름에는 번호를 접미사로 붙여 관리 및 구분함 

## 10.2 도커 컴포즈의 오버라이드 파일
- 도커 컴포즈는 컴포즈 파일을 환경 별로 복사해서 따로 설정 내용을 관리하지 않더라도 추가적인 컴포즈 파일을 통해 오버라이드 할 수 있는 기능을 제공함
- 이를 통해, 환경/설정 별로 도커 컴포즈 파일을 각각 따로 관리하지 않아도 됨
- 어느 특정 환경에만 적용하고 싶은 변경 내용을 해당 환경의 오버라이드 파일만을 반영하여 수정함
- 해당 오버라이드 파일은 각 환경의 차이점만 정리돼 있기 때문에 환경 별 차이점을 정리한 문서 파일이 되기도함

  ![CleanShot 2024-12-08 at 22 19 32@2x](https://github.com/user-attachments/assets/7113831f-2941-49e0-b6dd-933794ecc1b1)

- `config` 명령을 통해 입력 파일의 내용을 검증해 내용이 유효한 경우에만 최종 출력을 내놓음
- 이 최종 출력물이 실제 반영되는 컴포즈 파일이 되므로 오버라이드 파일을 적용한 결과를 예상할 수 있게 도와줌
  - 즉, 기본 파일과 오버라이드 파일이 병합된 컴포즈 파일을 미리 볼 수 있음

- 도커 컴포즈가 오버라이드 파일을 병합하는 순서는 인자로 받은 순서임
  - 인자로 지정된 순서가 먼저인 파일이 순서가 나중인 파일보다 우선함
  - 참고로, 순서가 중요함, 나중에 꼬이게 되면 원치않는 결과를 얻을 수 있음. 반영 전에 config로 확인이 필요함. 또는 최종 결과물만 깃으로 관리하는 방법도 좋음
 
- 이를 통해서 우리가 구성하고 싶은 여러 환경에 어플리케이션 구성을 단일 호스트에 구성이 가능하게 됨
  - 각각의 환경마다 독립성을 보장함
 
  ![CleanShot 2024-12-08 at 22 26 03@2x](https://github.com/user-attachments/assets/cc7e099e-30cc-4a81-852b-1a55624eddde)

## 10.3 환경 변수와 비밀값을 이용해 설정 주입하기
- 대부분의 어플리케이션은 설정을 환경 변수나 설정 파일로부터 읽어 오는데, 도커 컴포즈도 이들 수단을 충실히 지원함

- **`environment 프로퍼티`**
  - 컨테이너 내부에서 사용되는 환경 변수를 추가하는 방법
	- 보통 애플리케이션에서 데이터베이스나 파일(예: SQLite)에 설정값을 전달하는 간단한 방법으로 사용함
  - 컴포즈 파일에 대한 가독성이 좋으나, 하드코딩된 값이기에 민감 정보에는 사용하지 않는 것이 좋음
- **`env_file 프로퍼티`**
  - 텍스트 파일에 정의된 환경 변수를 컨테이너에 적용함
  - 텍스트 파일에서 변수 이름과 값을 = 로 구분하여 한 줄에 하나씩 정의하여 사용
	- 여러 환경 변수를 한 번에 정의 가능하며, 동일 파일을 여러 컴포넌트에서 공유 가능함
  - 서비스간에 공유하는 설정이 많은 경우에 유용함
  - 특정 위치에 파일을 읽어 설정을 반영하기 때문에 원격 컴퓨터에서 실행 중인 도커 엔진을 다룰 때도 로컬 컴퓨터의 설정값을 적용 가능함
- **`secrets 프로퍼티`**
  - services나 networks처럼 컴포즈 파일의 최상위 프로퍼티로 민감한 설정값(예: 데이터베이스 연결 정보)을 안전하게 정의함
  - 모든 컨테이너 런타임에서 적용 가능하며, 유출된 우려가 없기 때문에 유연성면에서 가장 뛰어남
  - 도커 스웜이나, 쿠버네티스에서도 사용됨
- **`.env 파일`**
  - 따로 지정하지 않더라도 해당 파일이 도커 컴포즈 설정 파일과 함께 있다면 해당 내용을 가져와서 반영함
  - 환경을 막론하고 기본 설정을 지정할 때 유용함
  - 두가지 정보를 포함
    - 컨테이너 설정
    - 도커 컴포즈 명령에 대한 설정 

## 10.4 확장 필드로 중복 제거하기
- 위의 방법으로도 보통 많은 경우를 해결하지만, 한계점이 있음
- 가장 흔한 경우는 서비스 간 많은 설정값을 공유하는 컴포즈 파일의 덩치가 점점 커질때 관리의 어려움이 생김
- 이를 YAML의 확장 필드 기능으로 해결 가능함
  - YAML의 문법에서 지원하는 기능임. 다만, 많이 사용하지는 않는 듯함  

- 확장 필드는 스크립트의 중복을 제거하는 동시에 잠재적인 오류를 줄여줌
- 일종의 사용자 정의 필드로 확장 필드에서 정의한 내용을 다른 곳에서도 재사용할 수 있음
- 최상위 블록 외부라면 어디서든 정의할 수 있으면 이름에 `앰퍼샌드(&)` 문법을 사용함
  - 정의한 값을 재사용할 때는 YAML 병합 문법(`<<:*`)을 사용함

  ![CleanShot 2024-12-08 at 22 36 52@2x](https://github.com/user-attachments/assets/f7eac9e0-5db7-46ca-8eb6-d84ba5f81ee7)

  ![CleanShot 2024-12-08 at 22 41 10@2x](https://github.com/user-attachments/assets/f2de7433-7ac7-4cdc-9a4e-fbd4e4f8b5cb)

- 중복이 많은 YAML 파일을 작성할때 유용함
- 다만, 여러 컴포즈 파일에 한꺼번에 적용할 수 없다는 한계점은 존재함

## 10.5 도커를 이용한 설정 워크플로 이해하기
- 환경 별로 어플리케이션은 설정의 차이가 존재함
- 이를, 도커 컴포즈를 통해 많이 보완할 수 있음
  - 도커 컴포즈의 기능과 소스 코드 형상 관리를 통해서

- **`도커 컴포즈를 이용하여 서로 다른 환경을 구성 및 정의하는 방법 요약`**
  - **`애플리케이션 구성 요소의 조합`**
  	- 모든 환경에서 어플리케이션 전체 스택(컴포넌트)을 실행할 필요는 없음
  	- 따라서, 테스트 환경에서는 모니터링의 일부와 컨테이너 내부 데이터베이스를 활용하고, 운영 환경에서는 클라우드 데이터베이스 사용 하는식으로 구분하여 구성 및 배포
    - 이는 오버라이드 파일 사용하여 동일한 서비스를 그대로 두고 환경별로 필요한 설정 및 구성만 작성하여 반영할 수 있음
    - 또한, 필요한 컴포넌트만 별도로 테스트 가능함
    - 환경마다 필요한 서비스를 달리하는 설정을 깔끔하고 간편하게 작성 가능
  
  - **`컨테이너 설정`**
    - 환경별 요구 사항에 맞춰 설정을 다르게 반영
  	- 예를 들어 테스트 환경은 로컬 드라이브 사용하고 운영 환경은 공유 스토리지를 사용하도록 설정을 분리
  	- 오버라이드 파일과 네트워크 활용하여 이러한 요구사항을 만족함
  	- 각 애플리케이션을 분리하여 단일 서버에서 여러 애플리케이션 실행 가능함
  
  - **`애플리케이션 설정`**
    - 환경별로 설정에 차이가 있음(ex.로그 수준, 캐시 크기 등 환경에 따라 동작을 다르게 해야하는 경우)
  	- 설정 주입 방식을 통해 특정 기능을 활성화/비활성화하거나 컨테이너 내부에서 환경에 맞는 설정을 적용 가능
      - 오버라이드 파일, 환경 파일, 비밀값 등을 활용 

- 예시

  ![CleanShot 2024-12-08 at 22 43 38@2x](https://github.com/user-attachments/assets/bf2213e8-72e5-4970-b7c0-3d1f36a9f66a)

- 이러한 워크플로에서 중요한 점은 모든 환경에서 같은 이미지를 사용한다는 것임
- 보통은 이점을 이용하여 빌드 프로세스 파이프라인을 구축하고 모든 검증 및 테스트가 완료되었을때 쿠버네티스와 같은 컨테이너 오케스트레이션 환경에 배포함
