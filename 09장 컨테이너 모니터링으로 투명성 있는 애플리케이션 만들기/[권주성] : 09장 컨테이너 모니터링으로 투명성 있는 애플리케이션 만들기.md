# 09장 컨테이너 모니터링으로 투명성 있는 애플리케이션 만들기
- 컨테이너에서 실행하는 애플리케이션에 있어 **`투명성(Observablity)`** 은 매우 중요한 요소
  - 애플리케이션 상태를 실시간으로 파악
  - 문제 원인을 빠르게 식별하고 해결
  - 효율적인 리소스 관리

## 9.1 컨테이너화된 애플리케이션 사용되는 모니터링 기술 스택
- 컨테이너 환경과 일반 환경의 모니터링 방식은 차이가 있음
- `기존 모니터링 방식`
  - 디스크 공간, 메모리 사용량, CPU 사용량, 등을 확인
	- 고정된 서버 리스트를 기준으로 상태를 확인함
  - 서버가 문제가 발생하거나 다운되면 관리자는 경고 알림을 받고 문제를 해결함
- `컨테이너 환경 방식`
  - 컨테이너 환경만의 특성을 고려해야하기 때문에 기존 방식에 더해 새로운 방식이 필요
	  - IP 주소와 위치가 비고정적
    - 다양한 어플리케이션을 아우룰수 있는 표준화된 측정값 포맷이 필요함
    - 컨테이너별로 상태를 확인할 수 있어야함

  ![CleanShot 2024-12-01 at 22 09 46@2x](https://github.com/user-attachments/assets/ab2d0663-efbc-4460-924c-34127dc19a3e)

- 컨테이너/클라우드(CNCF) 모니터링 환경에서 최신 트렌드는 `Grafana LGTM 스택`임
  - L : Loki (로그 수집 저장소)
  - G : Grafana (시각화)
  - T : Tempo (분산 추적 저장소 , APM)
  - M : Mimr (시계열 메트릭 저장소)
 
- 여기에 책에서 설명한 Prometheus, Jaeger, 등이 사용됨
- 또한 표준화된 Observablity를 위한 OpenTelemetry도 자주 사용함
- 해당 책에서 핵심 내용은 아니기 때문에 키워드만 가지고 따로 학습해보길 권장

## 9.2 애플리케이션의 측정값 출력하기
- 기존의 도커 엔진 상태 측정값을 넘어, 애플리케이션의 성능과 상태를 나타내는 데이터를 제공해야 함
- 주요 데이터를 HTTP 엔드포인트로 노출하여 프로메테우스 등 모니터링 도구가 수집할 수 있도록 설정
- 운영 환경에서 어떤 측정값을 사용할 것인가에 대한 기준
  - 외부 시스템과의 통신에 걸린 시간과 성공적으로 응답 받았는지 여부에 대한 기록
  - 사업 부서에서 필요로 하는 애플리케이션의 상태 및 사용자 행동에 관한 모든 정보
  - 로그로 남길 가치가 있는 모든 정보

## 9.3 측정값 수집을 맡을 프로메테우스 컨테이너 실행하기
- 프로메테우스는 HTTP 엔드포인트(/metrics)에서 데이터를 주기적으로 가져오는데 이를 스크래핑(Scraping)이라고 함
  - 데이터를 수집하고 타임스탬프와 함께 저장

- 프로메테우스는 풀링(pulling) 방식 직접 데이터를 요청하여 수집함
  - 수집한 데이터는 시계열 데이터베이스에 저장

- 프로메테우스는 컨테이너 환경에서의 각 컨테이너가 노출한 측정값을 자동으로 탐색함
  - 동적 환경에서도 정확하게 상태를 추적 가능

- 프로메테우스 설정 구성
  - 글로벌 설정(global)
    - 스크래핑 주기와 같은 기본 동작을 정의.
	  - ex) 기본 스크래핑 주기 10초 설정.

      ```yaml
        global:
          scrape_interval: 10s
      ```

- 스크래핑 대상 설정(scrape_configs)
  - 데이터를 수집할 엔드포인트와 세부 동작을 설정
	- 설정 예시

      ```yaml
        scrape_configs:
          - job_name: "image-gallery"
            metrics_path: /metrics
            static_configs:
              - targets: ["image-gallery:8080"] ## 지정된 IP와 포트를 통해 데이터 수집
          - job_name: "access-log"
            dns_sd_configs: ## dns_sd_configs를 통해 여러 컨테이너를 자동 탐색
              - names: ["accesslog"]
                type: A
                port: 80
      ```
    -  설정 필드 설명
      - ob_name: 수집 작업 이름
    	- metrics_path: 수집할 측정값의 엔드포인트 경로
    	- static_configs: 단일 컨테이너에 대한 정적 설정
    	- dns_sd_configs: DNS를 통해 여러 컨테이너를 탐색

- 도커 기반 환경에서의 스크래핑
  - 도커 네트워크의 DNS를 활용하여 동적으로 스크래핑 대상 탐색
	- 클러스터에서 실행되는 모든 컨테이너를 자동으로 모니터링 가능

  ![Goodnotes 2024-12-01 22 29 08](https://github.com/user-attachments/assets/8c252c39-9420-4b16-92cf-3c7852a2dbbd)

- 프로메테우스의 이점
  - 자동화된 데이터 수집
	  - 동적으로 생성 및 삭제되는 컨테이너 상태를 실시간으로 반영
	  - 설정 파일만으로 모든 데이터 수집 자동화
	- 확장성
	  - 클러스터 환경에서 수백 개의 컨테이너를 동시에 모니터링 가능
	- 데이터 분석 기반
	  - 타임스탬프가 포함된 데이터로 시간 흐름에 따른 추세 분석 가능
	  - 리소스 사용량 및 장애 발생 패턴을 기반으로 운영 최적화

## 9.4 측정값 시각화를 위한 그라파나 컨테이너 실행하기
- Prometheus, Loki, Tempo 등은 모니터링 수집 도구임
- 이러한 도구들은 보통 데이터를 시각화할 수 있는 툴과 연동하는데 대표적인 것이 Grafana임

- 그라파나란?
  - 프로메테우스와 같은 데이터 소스에서 수집된 데이터를 시각화하고 대시보드 형태로 제공하는 오픈 소스 도구
	- 애플리케이션 및 컨테이너 상태를 실시간으로 모니터링하기 위해 사용함

- 주요 기능
  - 다양한 데이터 소스와의 통합 가능(프로메테우스, InfluxDB 등)
	- 실시간 대시보드 생성 및 커스터마이징 지원
  - 알림(Alerting) 기능으로 이상 징후에 대한 자동 경고 제공

- 왜 시각화가 필요한가?
  - 수집된 데이터는 텍스트 기반으로 복잡하고 이해하기 어려움
	- 시각화를 통해 데이터 추세와 패턴을 직관적으로 파악
  - 장애 원인 및 문제를 빠르게 탐지하고 대응 가능


- 그라파나 설치 및 실행

```sh
docker run -d -p 3000:3000 grafana/grafana
```

- 기본 웹 UI 주소: http://localhost:3000
- 기본 로그인 정보
  - 사용자명: admin
	- 비밀번호: admin

- Docker Compose로 실행

```yaml
services:
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
```

- 프로메테우스 데이터 소스 추가해야함

- 그라파나 활용
  - 실시간 상태 모니터링
	  - 대시보드에서 컨테이너 및 애플리케이션 상태를 실시간으로 파악
	  - 트래픽 증가, 응답 시간 증가 등 이상 상태를 즉시 확인
	- 이상 징후 탐지
	  - 메모리 사용량 급증, 요청 실패율 상승 등 문제 상황을 대시보드에서 시각적으로 확인
	  - 경고(Alerting) 기능으로 운영팀에 즉시 알림 전송
	- 장기적 데이터 분석:
	  - 대시보드 데이터를 기반으로 성능 추세 분석
	  - 자원 사용량 예측 및 스케일링 전략 수립
	- 개발 및 운영 협업 지원
	  - 운영팀과 개발팀이 동일한 대시보드를 보며 실시간으로 문제를 공유하고 협업 가능

- 그라파나의 이점
  - 직관적이고 강력한 시각화
	  - 복잡한 데이터를 그래프와 차트로 표현하여 이해하기 쉽도록 제공
	- 확장성과 통합성
	  - 다양한 데이터 소스와의 연동 가능
	  - 쿠버네티스, 도커, 프로메테우스 등과 통합하여 전체적인 시스템 상태 파악

## 9.5 투명성의 수준
- 실제 서비스가 가능한 수준으로 나아가기 위해서는 투명성이 반드시 필요함
- 해당 챕터에서 중요한 것은 컨테이너를 중심으로 만들어진 생태계와 이들 생태계를 구성하는 도구를 적용하고 활용,이해하는 패턴에 있음

- 컨테이너 모니터링의 개요

  ![Goodnotes 2024-12-01 22 29 56](https://github.com/user-attachments/assets/03794358-afaf-4d52-bd3e-d91b1a73167c)

- 중요한 것은 애플리케이션의 전체 상황을 조망할 수 있는 대시보드, 문제 발생시 빠르게 확인할 수 있는 알람, 문제 해결을 가능하도록 하는 로그, 등임 

## 9.6 연습 문제
  
  ![CleanShot 2024-12-01 at 22 35 24@2x](https://github.com/user-attachments/assets/55167b5c-f064-4f5e-b9cb-9810dbc55247)

- Docker Compose 설정

  ![IntelliJ IDEA 2024-12-01 22 34 02](https://github.com/user-attachments/assets/40a5184d-f5eb-4502-b305-d1e16acb5e16)

- Prometheus 설정

  ![IntelliJ IDEA 2024-12-01 22 34 14](https://github.com/user-attachments/assets/ab871d76-06cf-4afb-b167-5ad1cfe17621)

- Grafana 화면

  ![CleanShot 2024-12-01 at 21 16 33@2x](https://github.com/user-attachments/assets/402bd2dd-40d8-4e0b-94be-4798079a8c20)

  
