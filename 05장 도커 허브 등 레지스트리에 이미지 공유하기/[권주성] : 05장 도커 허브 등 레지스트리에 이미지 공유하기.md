# 05장 도커 허브 등 레지스트리에 이미지 공유하기
- 앞서서 `빌드`와 `실행`에 대해 배웠고, 이번 장에서는 **`공유`** 에 대해 배움
  - 내가 빌드한 이미지를 다른 사람이 사용
  - 누가 어떤 환경에서 시도하더라도 사용할 수 있어야함 

- 도커의 핵심 장점 중 하나
  - 환경의 차이를 극복할 수 있게 해줌 

## 5.1 레지스트리, 리포지터리, 이미지 태그 다루기
- 도커 플랫폼은 소프트웨어 배포의 기능을 내장하고 있음
  - 로컬 컴퓨터에 이미지가 없으면 자동으로 이미지를 다운 받아줌
  - 이미지는 **`도커 레지스트리`** 에서 다운함

- **`도커 레지스트리`** 중 가장 유명한 것은 `도커 허브`(디폴트) 임

- 도커 이미지에는 유니크한 식별할 수 있는 이름이 부여됨
  - 이 이름에 해당 이미지를 내려받기 위해 필요한 모든 정보가 들어 있음
  
  ![CleanShot 2024-11-10 at 21 53 54@2x](https://github.com/user-attachments/assets/53abd963-6f2f-422d-9406-daacec72eca1)

- **`이미지 전체 이름`** (이미지 참조(Reference) 라고도 부름)은 네가지 구성 요소로 이루어짐
  - `이미지가 저장된 레지스트리의 도메인`(도커 허브가 디폴트 값)
  - `이미자 작성자의 계정 이름`(개인 or 단체)
  - `이미지 리포지터리 이름`(어플리케이션 명)
  - `이미지 태그`(latest가 디폴트)
    - 따라서, 오해를 줄이기 위해 항상 명시적으로 태그를 사용하는 것이 좋음 

## 5.2 도커 허브에 직접 빌드한 이미지 푸시하기
- 도커 허브에 이미지를 푸시하려면 도커 허브 계정이 필요함
- 그리고 도커 명령으로 레지스트리에 로그인해야함
  - 그래야 레지스트리에 이미지를 푸시할 권한이 부여됨 

#### 도커 허브 계정 이름을 환경 변수로 정의하기 
```bash
  # 리눅스 또는 Mac OS 환경의 배시 셸
  export dockerId="도커허브계정이름"
```

#### 도커 허브에 로그인하기
```bash
  docker login --username $dockerId
```

#### 기존 이미지에 새로운 이미지 참조 부여하기
```bash
  docker image tag image-gallery $dockerId/image-gallery:v1
```

#### 도커 이미지를 레지스트리에 푸시하기
```bash
  docker image push $dockerId/image-gallery:v1
```

- 도커 레지스트리도 로컬 처럼 이미지 레이어를 다룸
- 즉, 레지스트리에서도 캐시가 이루어지고 없는 경우에만 실제 업로드가 진행됨
- 이는 Dockerfile 스크립트의 최적화가 더욱 중요한 이유임
  - 빌드 시간, 디스크 용량을 넘어 네트워크 대역폭까지 영향을 미치기 때문에 효율이 중요함 

#### 도커 허브에 푸시된 이미지 확인하기
```bash
  echo "https://hub.docker.com/r/$dockerId/image-gallery/tags"
```


## 5.3 나만의 도커 레지스트리 운영하기
- 레지스트리는 개방형 API 명세이기 때문에, 오픈 소스 형태로 존재하며 운영 중
  - 다른 벤더 상에서도 이를 만족하는 여러 서비스를 운영 중임(ex. AWS ECR, 등) 

- 따라서, 해당 오픈 소스(코어 레지스트리 서버)를 활용하여 나만의 로컬 레지스트리를 운영할 수 있음

#### 컨테이너 형태로 도커 레지스트리 실행하기
```bash
  # --restart 플래그를 부여하면 도커를 재시작했을 때 해당 컨테이너도 자동으로 재시작 됨
  docker container run -d -p 5000:5000 --restart always diamol/registry
```

#### 로컬 레지스트리에 이미지 추가하기
```bash
  docker image tag image-gallery 127.0.0.1:5000/gallery/ui:v1
```


- 로컬 레지스트리는 별도의 인증 수단이 없음
  - 직접 운영하기 위해서 쓰기에는 어려움
  - 다만, 소규모 팀이나, 자신만의 이미지 참조 명명 체계를 만들 수 있다는 장점이 있음 

#### 도커 설정
- 이미지 레이어의 저장 경로, 도커 API가 주시하는 포트 번호, 허용된 비보안 레지스트리 목록 등 도커 엔진의 모든 설정은 **`demon.json`** 이라는 파일에 들어 있음
  - 리눅스의 경우 `/etc/docker`에 있음
 
#### 비보안 레지스트리 허용 목록에 추가하기
- 도커는 레지스트리에서 보안을 위해 HTTPS로만 이미지를 가져올 수 있도록 하였기 때문에 로컬에서 사용하기 위해서는 비보안 레지스트리 목록에 로컬 레지스트리를 등록해야함

## 5.4 이미지 태그를 효율적으로 사용하기
- 도커 이미지 태그에는 어떤 문자열이라도 포함할 수 있음
- 같은 이미지에 여러 개의 태그를 부여하는 것도 가능
- 태그를 통해 버전을 구별하고 이미지를 사용할 다른 사람들이 자신이 원하는 이미지를 찾을 수 있음

- 도커에서도 사용되는 기본적인 버전 표현법

  ![CleanShot 2024-11-10 at 22 24 04@2x](https://github.com/user-attachments/assets/2937d886-c2f7-4e14-8c9e-18055679dd2c)

  - (기본적인) 버전 표현법은 `[major].[minor].[patch].[build]` 를 의미함
    - major는 완전히 다른 기능을 가짐을 의미
    - minor는 추가된 기능은 있으나 기존 기능은 모두 유지
    - patch는 버그 수정
    - build는 내부적으로 구분하기 위해 사용

  - 이미지 태그에도 이러한 방식이 사용됨
    - 사용자들이 어떤 이미지를 선택하고 제공받을 것인가를 선택할 수 있게됨  

  - 만약, 패치 업데이트를 자동으로 전달 받고 싶다면 2.1 태그를 사용하면 2.1 이후의 수정된 버전은 (예를 들어 2.1.1 에서 2.1.2로 업데이트) 자동으로 업데이트된 버전으로 제공받게 됨

## 5.5 공식 이미지에서 골드 이미지로 전환하기
- 도커 허브는 `검증된 퍼블리셔(verified publicher)`와 `공식 이미지(official image)` 제도를 운영하여 해커의 공격(바이러스 배포)에 대한 피해를 방지함
  - 이미지를 배포하는 단체 중에 MS,Oracle,등 빅테크기업을 검증된 퍼블리셔로 지정함(이들이 배포하는 이미지는 취약점 탐지와 같은 검증을 통한 승인 절차를 거쳐서 배포됨)
    - 해당 이미지는 도커와 해당 퍼블리셔의 지원을 받을 수 있음을 의미

  - 공식 이미지는 주로 오픈 소스로 해당 프로젝트 개발 팀과 도커가 함께 이미지를 관리함(이 또한 배포하는 이미지에서 취약점 탐지와 같은 검증을 통한 승인 절차를 거쳐서 배포됨)

- 공식 이미지를 사용하다 보면 좀 더 많은 것을 통제하고 싶은 시점이 생김. → 이때 자신이 선하는 기반 이미지로 전환하고 원하는 대로 커스텀하는 이미지가 생김. 이를 `골든 이미지(Golden image)`라고 부름

  ![CleanShot 2024-11-10 at 22 34 33@2x](https://github.com/user-attachments/assets/fa9ad559-3227-4def-9126-3c0c787cab32)

  - 공식 이미지를 기반 이미지로 삼아 인증서나 환경 설정 값 등 자신이 필요한 설정을 추가한 것
  - 도커와 함께 최적화된 공식 이미지의 이점을 그대로 누리면서 필요한 설정을 추가할 수 있는다는 것이 장점 

## 5.6 연습문제
- 도커 레지스트리 API V2 명세가 담긴 문서 조사하기
- gallery/ui 이미지의 모든 태그를 로컬 컴퓨터의 레지스트리에 푸시하기 및 삭제하기
